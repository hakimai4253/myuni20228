<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¬ä¸»çš„é­”æ³•æ›´è¡£å®¤</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ffeaa7;
            --main-pink: #fab1a0;
            --deep-pink: #e84393;
            --purple: #6c5ce7;
            --pixel-font: 'VT323', monospace;
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--bg-color);
            background-image: radial-gradient(#fab1a0 15%, transparent 16%), radial-gradient(#fab1a0 15%, transparent 16%);
            background-size: 20px 20px;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .game-boy {
            background-color: #fff0f5;
            width: 95%;
            max-width: 600px;
            height: 90vh;
            border-radius: 20px;
            border: 4px solid var(--purple);
            box-shadow: 10px 10px 0px rgba(108, 92, 231, 0.4);
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 10px;
            box-sizing: border-box;
        }

        /* --- é¡¯ç¤ºå€åŸŸ (Screen) --- */
        .screen-container {
            background-color: #ffe0e9;
            border: 4px solid var(--purple);
            border-radius: 10px;
            flex: 1;
            overflow-y: auto;
            position: relative;
            padding: 15px;
            display: flex; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤ºå“ªå€‹ screen */
            flex-direction: column;
        }

        .screen-section {
            display: none; /* é è¨­æ‰€æœ‰ç•«é¢éš±è— */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        
        .screen-section.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- è§’è‰²æ›è£å€ (Canvas) --- */
        .princess-stage {
            width: 250px;
            height: 300px;
            background: #fff;
            border: 4px solid gold;
            border-radius: 50% 50% 10px 10px;
            position: relative;
            margin: 10px auto;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        /* æ›è£åœ–å±¤ */
        .layer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.5s;
            opacity: 0.3; /* æœªç²å¾—æ™‚åŠé€æ˜ */
            filter: grayscale(100%);
        }
        
        .layer.unlocked {
            opacity: 1;
            filter: grayscale(0%);
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* å„éƒ¨ä½å®šä½ (ä½¿ç”¨ Emoji æˆ–ç°¡å–®åœ–å½¢æ¨¡æ“¬) */
        .layer-base { top: 60px; font-size: 80px; z-index: 1; opacity: 1; filter: none; } /* è‡‰ */
        .layer-dress { top: 130px; font-size: 120px; z-index: 2; } /* è¡£æœ */
        .layer-shoes { top: 230px; font-size: 40px; z-index: 3; } /* é‹å­ */
        .layer-hair { top: 40px; font-size: 90px; z-index: 4; } /* é«®é£¾/é ­é«® */
        .layer-wand { top: 140px; left: 75%; font-size: 60px; z-index: 5; transform: translateX(-50%) rotate(15deg); } /* é­”æ³•æ£’ */
        .layer-pet { top: 180px; left: 20%; font-size: 50px; z-index: 6; } /* å¯µç‰© */
        .layer-crown { top: 10px; font-size: 60px; z-index: 7; } /* çš‡å†  */

        /* --- ä»‹é¢å…ƒä»¶ --- */
        h1, h2 { color: var(--deep-pink); margin: 5px 0; text-shadow: 2px 2px 0 #fff; }
        
        .pixel-btn {
            background-color: var(--deep-pink);
            border: 2px solid #000;
            color: #fff;
            padding: 10px 20px;
            font-family: var(--pixel-font);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            margin: 10px;
            border-radius: 8px;
        }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.2); }
        
        .input-box {
            font-family: var(--pixel-font);
            font-size: 1.5rem;
            padding: 8px;
            border: 3px solid var(--purple);
            border-radius: 5px;
            text-align: center;
            width: 80%;
            margin: 10px 0;
        }

        .avatar-select { display: flex; gap: 10px; justify-content: center; margin: 10px; }
        .avatar-opt { font-size: 2.5rem; cursor: pointer; border: 3px solid transparent; border-radius: 50%; padding: 5px; background: #fff; }
        .avatar-opt.selected { border-color: var(--deep-pink); background: #ffeaa7; animation: bounce 0.5s; }

        /* é¡Œç›®å€ */
        .quiz-panel { width: 100%; text-align: left; }
        .question-row { 
            background: #fff; border: 2px solid var(--purple); margin-bottom: 8px; padding: 10px; 
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 1.4rem;
        }
        .question-row input { font-size: 1.4rem; width: 60px; text-align: center; border: 2px solid #ccc; border-radius: 4px; font-family: var(--pixel-font); }
        .correct-ans { color: green; font-size: 1rem; margin-left: 5px; }

        /* æ•…äº‹å¡ç‰‡ */
        .story-card {
            background: #fff;
            padding: 20px;
            border: 4px dashed var(--purple);
            border-radius: 15px;
            max-width: 90%;
        }
        .story-text { font-size: 1.6rem; line-height: 1.4; color: #2d3436; margin-bottom: 20px; }
        .item-preview { font-size: 5rem; animation: float 2s infinite ease-in-out; margin: 10px 0; }

        @keyframes bounce { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        @keyframes rotate { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* ç…™ç«ç‰¹æ•ˆ (ç°¡å–®ç‰ˆ) */
        .firework {
            position: absolute; width: 10px; height: 10px; border-radius: 50%;
            animation: explode 1s ease-out forwards; pointer-events: none;
        }
        @keyframes explode { to { transform: scale(10); opacity: 0; } }

    </style>
</head>
<body>

<div class="game-boy">
    <div class="screen-container">
        
        <div id="screen-setup" class="screen-section active">
            <h1>ğŸ‘‘ å…¬ä¸»æª”æ¡ˆå»ºç«‹ ğŸ‘‘</h1>
            <p>è«‹è¼¸å…¥å…¬ä¸»çš„åå­—ï¼š</p>
            <input type="text" id="player-name" class="input-box" placeholder="ä¾‹å¦‚: è‰¾è" maxlength="8">
            
            <p>é¸æ“‡ä½ çš„æ¨£å­ï¼š</p>
            <div class="avatar-select">
                <div class="avatar-opt" onclick="selectAvatar('ğŸ‘§')">ğŸ‘§</div>
                <div class="avatar-opt" onclick="selectAvatar('ğŸ‘©â€ğŸ¦°')">ğŸ‘©â€ğŸ¦°</div>
                <div class="avatar-opt" onclick="selectAvatar('ğŸ‘±â€â™€ï¸')">ğŸ‘±â€â™€ï¸</div>
                <div class="avatar-opt" onclick="selectAvatar('ğŸ‘©â€ğŸ¦±')">ğŸ‘©â€ğŸ¦±</div>
            </div>
            
            <button class="pixel-btn" onclick="startGame()">å»ºç«‹æª”æ¡ˆ & é–‹å§‹</button>
        </div>

        <div id="screen-home" class="screen-section">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <div style="font-size:1.2rem;">å…¬ä¸»: <span id="display-name" style="color:var(--deep-pink); font-weight:bold;"></span></div>
                <button style="font-size:0.8rem; background:#b2bec3; border:1px solid #000; cursor:pointer;" onclick="resetGame()">é‡ç½®</button>
            </div>

            <div class="princess-stage">
                <div id="l-base" class="layer layer-base">ğŸ‘§</div>
                <div id="l-dress" class="layer layer-dress">ğŸ‘—</div>
                <div id="l-shoes" class="layer layer-shoes">ğŸ‘ </div>
                <div id="l-hair" class="layer layer-hair">ğŸ€</div>
                <div id="l-wand" class="layer layer-wand">ğŸª„</div>
                <div id="l-pet" class="layer layer-pet">ğŸ¦„</div>
                <div id="l-crown" class="layer layer-crown">ğŸ‘‘</div>
            </div>

            <div id="status-text" style="font-size: 1.2rem; color: #636e72;">æº–å‚™åƒåŠ çš‡å®¶èˆæœƒ...</div>
            <button id="next-level-btn" class="pixel-btn" onclick="enterStoryMode()">å‰å¾€ä¸‹ä¸€ç« </button>
        </div>

        <div id="screen-story" class="screen-section">
            <div class="story-card">
                <h2 id="story-title">ç¬¬ä¸€ç« </h2>
                <div id="story-reward-icon" class="item-preview">ğŸ‘—</div>
                <p id="story-content" class="story-text">æ•…äº‹å…§å®¹...</p>
                <button class="pixel-btn" onclick="startQuiz()">æ¥å—è©¦ç…‰</button>
            </div>
        </div>

        <div id="screen-quiz" class="screen-section" style="justify-content: flex-start;">
            <div style="display:flex; justify-content:space-between; width:100%; margin-bottom:10px; border-bottom:2px dashed #000; padding-bottom:5px;">
                <span>è©¦ç…‰ä¸­...</span>
                <span id="timer">00:00</span>
            </div>
            <div id="quiz-list" class="quiz-panel">
                </div>
            <button class="pixel-btn" style="background:#00b894; width:100%;" onclick="submitQuiz()">æ–½å±•é­”æ³• (æäº¤)</button>
        </div>

        <div id="screen-success" class="screen-section">
            <h1 style="font-size:3rem;">âœ¨ è©¦ç…‰æˆåŠŸ âœ¨</h1>
            <p style="font-size:1.5rem;">ä½ ç²å¾—äº†ï¼š<span id="reward-name" style="color:var(--deep-pink); font-weight:bold;"></span></p>
            <div id="reward-display" style="font-size:6rem; animation: bounce 1s infinite;"></div>
            <p>ç¶“é©—å€¼ +100</p>
            <button class="pixel-btn" onclick="goHome()">ç©¿ä¸Šè£å‚™</button>
        </div>
        
        <div id="screen-final" class="screen-section">
            <h1 style="color:#d63031;">ğŸ‰ å®Œç¾å…¬ä¸»èª•ç”Ÿ ğŸ‰</h1>
            <div class="princess-stage" style="transform: scale(1.2); margin: 30px auto; background: linear-gradient(to top, #fff 0%, #fff0f5 100%);">
                 <div id="f-base" class="layer layer-base" style="opacity:1; filter:none;"></div>
                 <div class="layer layer-dress unlocked">ğŸ‘—</div>
                 <div class="layer layer-shoes unlocked">ğŸ‘ </div>
                 <div class="layer layer-hair unlocked">ğŸ€</div>
                 <div class="layer layer-wand unlocked">ğŸª„</div>
                 <div class="layer layer-pet unlocked">ğŸ¦„</div>
                 <div class="layer layer-crown unlocked">ğŸ‘‘</div>
            </div>
            <p style="font-size:1.5rem;">[NAME] å…¬ä¸»å·²ç¶“æº–å‚™å¥½åƒåŠ èˆæœƒäº†ï¼</p>
            <button class="pixel-btn" onclick="resetGame()">é‡æ–°é–‹å§‹å†’éšª</button>
        </div>

    </div>
</div>

<script>
    // --- éŠæˆ²è³‡æ–™èˆ‡è¨­å®š ---
    let player = {
        name: "",
        avatar: "ğŸ‘§",
        level: 0, // ç•¶å‰é—œå¡ (0-5)
        unlocked: [false, false, false, false, false, false] 
    };

    // é—œå¡è¨­å®šï¼šæ•…äº‹ã€çå‹µã€é¡Œç›®é¡å‹
    const stages = [
        {
            title: "ç¬¬ä¸€ç« ï¼šç©ºè•©è•©çš„è¡£æ«¥",
            text: "èˆæœƒé‚€è«‹å‡½å¯„ä¾†äº†ï¼å¯æ˜¯å…¬ä¸»æ‰“é–‹è¡£æ«¥ï¼Œç™¼ç¾è£¡é¢ç©ºç©ºå¦‚ä¹Ÿã€‚è®“æˆ‘å€‘é‹ç”¨ã€ŒåŠ æ³•é­”æ³•ã€è®Šå‡ºä¸€ä»¶ç¾éº—çš„ç¦®æœå§ï¼",
            itemIcon: "ğŸ‘—", itemName: "æ˜Ÿç©ºç¦®æœ", layerId: "l-dress",
            quizType: ["add"], difficulty: {min:10, max:50}
        },
        {
            title: "ç¬¬äºŒç« ï¼šèµ¤è…³çš„å°·å°¬",
            text: "ç©¿ä¸Šäº†ç¦®æœï¼Œä½†ä½é ­ä¸€çœ‹...æ€éº¼é‚„æ˜¯å…‰è‘—è…³ä¸«ï¼Ÿçš‡å®®çš„åœ°æ¿å¾ˆå†°çš„ï¼å¿«ç”¨ã€Œæ¸›æ³•é­”æ³•ã€æ‰¾å›ç»ç’ƒé‹ï¼",
            itemIcon: "ğŸ‘ ", itemName: "ç»ç’ƒé‹", layerId: "l-shoes",
            quizType: ["sub"], difficulty: {min:20, max:60}
        },
        {
            title: "ç¬¬ä¸‰ç« ï¼šäº‚ç³Ÿç³Ÿçš„é ­é«®",
            text: "ç…§ç…§é¡å­ï¼Œé ­é«®ç¡å¾—äº‚ä¸ƒå…«ç³Ÿã€‚éœ€è¦ä¸€å€‹æ¼‚äº®çš„è´è¶çµä¾†æ•´ç†å„€å®¹ã€‚é€™æ¬¡è¦è€ƒé©—ä½ çš„ã€Œä¹˜æ³•æ™ºæ…§ã€ï¼",
            itemIcon: "ğŸ€", itemName: "çµ²ç¶¢è´è¶çµ", layerId: "l-hair",
            quizType: ["mul"], difficulty: {min:2, max:9}
        },
        {
            title: "ç¬¬å››ç« ï¼šéœ€è¦ä¸€é»é˜²è­·",
            text: "è½èªªå»èˆæœƒçš„è·¯ä¸Šæœ‰å£è„¾æ°£çš„å·¨é­”ï¼Ÿä½ éœ€è¦ä¸€æ”¯é­”æ³•æ£’ä¾†ä¿è­·è‡ªå·±ï¼çœ‹æ‡‚ã€Œæ™‚é–“ã€æ‰èƒ½æŠ“ä½é­”æ³•çš„æœ€ä½³æ™‚æ©Ÿï¼",
            itemIcon: "ğŸª„", itemName: "æ˜Ÿå…‰é­”æ³•æ£’", layerId: "l-wand",
            quizType: ["clock"], difficulty: {}
        },
        {
            title: "ç¬¬äº”ç« ï¼šæ¼«é•·çš„è·¯é€”",
            text: "çš‡å®®å¤ªé äº†ï¼Œèµ°è·¯æœƒé²åˆ°çš„ã€‚å¬å–šå‚³èªªä¸­çš„ç¥ç¸å¤¥ä¼´è¼‰æˆ‘å€‘ä¸€ç¨‹å§ï¼ç¶œåˆé‹ç”¨ä½ æ‰€æœ‰çš„æ•¸å­¸èƒ½åŠ›ï¼",
            itemIcon: "ğŸ¦„", itemName: "å½©è™¹ç¨è§’ç¸", layerId: "l-pet",
            quizType: ["add", "sub", "word"], difficulty: {min:20, max:80}
        },
        {
            title: "æœ€çµ‚ç« ï¼šåŠ å†•æ™‚åˆ»",
            text: "çµ‚æ–¼æŠµé”èˆæœƒç¾å ´ï¼Œå¤§å®¶éƒ½ç‚ºä½ é©šå˜†ã€‚åœ‹ç‹æ±ºå®šç‚ºæœ€è°æ˜çš„å…¬ä¸»æˆ´ä¸Šçš‡å† ï¼é€™æ˜¯æœ€å¾Œçš„è©¦ç…‰ï¼",
            itemIcon: "ğŸ‘‘", itemName: "å¥³ç‹çš‡å† ", layerId: "l-crown",
            quizType: ["add", "sub", "mul", "clock", "word"], difficulty: {min:10, max:99}
        }
    ];

    let currentQuestions = [];
    let selectedAvatar = "ğŸ‘§";

    // --- åˆå§‹åŒ–èˆ‡å­˜æª” ---
    window.onload = function() {
        if(localStorage.getItem('princessStorySave')) {
            player = JSON.parse(localStorage.getItem('princessStorySave'));
            if(player.name) {
                showScreen('screen-home');
                updateHomeVisuals();
            }
        }
    };

    function saveGame() {
        localStorage.setItem('princessStorySave', JSON.stringify(player));
    }

    function resetGame() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤å…¬ä¸»æª”æ¡ˆä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ")) {
            localStorage.removeItem('princessStorySave');
            location.reload();
        }
    }

    // --- ç•«é¢åˆ‡æ›èˆ‡é‚è¼¯ ---
    function showScreen(id) {
        document.querySelectorAll('.screen-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function selectAvatar(char) {
        selectedAvatar = char;
        document.querySelectorAll('.avatar-opt').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
    }

    function startGame() {
        const nameInput = document.getElementById('player-name').value.trim();
        if(!nameInput) { alert("è«‹è¼¸å…¥å…¬ä¸»çš„åå­—ï¼"); return; }
        
        player.name = nameInput;
        player.avatar = selectedAvatar;
        saveGame();
        
        showScreen('screen-home');
        updateHomeVisuals();
    }

    function updateHomeVisuals() {
        document.getElementById('display-name').innerText = player.name;
        document.getElementById('l-base').innerText = player.avatar;
        document.getElementById('f-base').innerText = player.avatar;

        // æ›´æ–°è£å‚™é¡¯ç¤ºç‹€æ…‹
        stages.forEach((stage, idx) => {
            const el = document.getElementById(stage.layerId);
            if(player.unlocked[idx]) {
                el.classList.add('unlocked');
            } else {
                el.classList.remove('unlocked');
            }
        });

        // åˆ¤æ–·æ˜¯å¦å…¨ç ´
        if(player.level >= 6) {
            document.getElementById('status-text').innerText = "æ‰€æœ‰è£å‚™å·²æ”¶é›†å®Œç•¢ï¼";
            document.getElementById('next-level-btn').innerText = "åƒåŠ åŠ å†•å…¸ç¦®";
            document.getElementById('next-level-btn').onclick = () => showFinal();
        } else {
            document.getElementById('status-text').innerText = `ç›®å‰é€²åº¦: ç¬¬ ${player.level + 1} ç« `;
            document.getElementById('next-level-btn').innerText = "å‰å¾€ä¸‹ä¸€ç« ";
            document.getElementById('next-level-btn').onclick = () => enterStoryMode();
        }
    }

    function enterStoryMode() {
        if(player.level >= 6) return;
        const stage = stages[player.level];
        document.getElementById('story-title').innerText = stage.title;
        document.getElementById('story-content').innerText = stage.text;
        document.getElementById('story-reward-icon').innerText = stage.itemIcon;
        showScreen('screen-story');
    }

    // --- æ¸¬é©—ç”¢ç”Ÿå™¨ (æ ¸å¿ƒé‚è¼¯) ---
    function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function startQuiz() {
        showScreen('screen-quiz');
        const container = document.getElementById('quiz-list');
        container.innerHTML = '';
        currentQuestions = [];
        
        const stage = stages[player.level];
        
        for(let i=0; i<5; i++) { // æ¯é—œ 5 é¡Œ
            const type = stage.quizType[Math.floor(Math.random() * stage.quizType.length)];
            createQuestion(i, type, stage.difficulty);
        }
    }

    function createQuestion(index, type, diff) {
        let q = { type: type, ans: null };
        let html = '';
        const min = diff.min || 10;
        const max = diff.max || 50;

        if(type === 'add') {
            let n1 = getRandomInt(min, max), n2 = getRandomInt(min, max);
            q.ans = n1 + n2;
            html = `${n1} + ${n2} = ?`;
        } else if(type === 'sub') {
            let n1 = getRandomInt(min, max), n2 = getRandomInt(min, max);
            if(n1 < n2) [n1, n2] = [n2, n1];
            q.ans = n1 - n2;
            html = `${n1} - ${n2} = ?`;
        } else if(type === 'mul') {
            let n1 = getRandomInt(2, 9), n2 = getRandomInt(2, 9);
            q.ans = n1 * n2;
            html = `${n1} Ã— ${n2} = ?`;
        } else if(type === 'clock') {
            let h = getRandomInt(1, 12), m = getRandomInt(0, 11) * 5;
            q.ans = `${h}:${m.toString().padStart(2,'0')}`;
            q.type = 'clock'; // ç‰¹æ®Šæ¨™è¨˜
            html = `æ™‚é˜æ˜¯ ${h}é»${m}åˆ† å—? (è¼¸å…¥ æ˜¯/å¦)`;
            // ç°¡åŒ–ç‰ˆï¼šæ™‚é˜é¡Œæˆ‘å€‘æ”¹ç‚ºç›´æ¥æ–‡å­—å•ç­”ï¼Œæˆ–è€…ç°¡å–®çš„æ•¸å­—é¡Œï¼Œé¿å…Canvas
