<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¬ä¸»çš„é­”æ³•æ›´è¡£å®¤</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ffeaa7;
            --deep-pink: #e84393;
            --light-pink: #fab1a0;
            --purple: #6c5ce7;
            --pixel-font: 'VT323', monospace;
            --reading-font: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }

        img { image-rendering: pixelated; }

        body {
            font-family: var(--reading-font);
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--light-pink) 15%, transparent 16%), radial-gradient(var(--light-pink) 15%, transparent 16%);
            background-size: 20px 20px;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none; 
            -webkit-user-select: none;
        }

        .game-boy {
            background-color: #fff0f5;
            width: 95%;
            max-width: 600px;
            height: 95vh;
            border-radius: 20px;
            border: 4px solid var(--purple);
            box-shadow: 10px 10px 0px rgba(108, 92, 231, 0.4);
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 10px;
            box-sizing: border-box;
        }

        .screen-container {
            background-color: #ffe0e9;
            border: 4px solid var(--purple);
            border-radius: 10px;
            flex: 1;
            overflow-y: auto;
            position: relative;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .screen-section {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        .screen-section.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å…¬ä¸»èˆå° (èª¿æ•´ç‰ˆ) --- */
        .princess-stage {
            width: 260px;
            height: 360px;
            background: #fff;
            border: 4px solid gold;
            border-radius: 20px; 
            position: relative;
            margin: 10px auto;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .layer-base-img { width: 100%; height: 100%; object-fit: contain; z-index: 1; }
        
        .layer {
            position: absolute;
            transition: all 0.5s;
            opacity: 0; 
            filter: grayscale(0%) drop-shadow(0px 0px 5px gold);
            pointer-events: none;
            font-size: 50px; 
        }
        .layer.unlocked { opacity: 1; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- ä¿®æ­£è£å‚™ä½ç½® (è§£æ±ºé‡ç–Šèˆ‡æ¶ˆå¤±å•é¡Œ) --- */
        .layer-crown { top: 5px; left: 50%; transform: translateX(-50%); font-size: 60px; z-index: 7; }
        
        /* å·¦å´é“å…· */
        .layer-hair { top: 20px; left: 5px; font-size: 50px; z-index: 5; }
        .layer-wand { top: 50%; left: 5px; font-size: 50px; z-index: 6; transform: translateY(-50%) rotate(-15deg); } /* ä¿®æ­£ï¼šç§»åˆ°å·¦ä¸­ */
        .layer-pet { bottom: 10px; left: 5px; font-size: 55px; z-index: 6; }

        /* å³å´é“å…· */
        .layer-dress { top: 20px; right: 5px; font-size: 50px; z-index: 5; }
        .layer-shoes { bottom: 10px; right: 5px; font-size: 40px; z-index: 5; }

        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* UI å…ƒä»¶ */
        h1, h2 { 
            color: var(--deep-pink); margin: 5px 0; text-shadow: 2px 2px 0 #fff; 
            font-family: var(--reading-font); font-weight: bold;
        }
        
        .pixel-btn {
            background-color: var(--deep-pink);
            border: 3px solid #000;
            color: #fff;
            padding: 10px 20px;
            font-family: var(--reading-font);
            font-weight: bold;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
            margin: 10px;
            border-radius: 12px;
            touch-action: manipulation;
            transition: all 0.1s;
        }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        
        .input-box {
            font-family: var(--reading-font); font-size: 1.5rem; padding: 10px; border: 3px solid var(--purple);
            border-radius: 10px; text-align: center; width: 80%; margin: 10px 0; background: #fff;
        }

        .avatar-select { display: flex; gap: 10px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .avatar-opt { 
            width: 70px; height: 70px; cursor: pointer; border: 4px solid #fff; border-radius: 15px; 
            padding: 2px; background: var(--light-pink); transition: all 0.2s; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); object-fit: contain; background-color: #fff;
        }
        .avatar-opt.selected { border-color: var(--deep-pink); transform: scale(1.1) translateY(-3px); box-shadow: 5px 5px 0px rgba(232, 67, 147, 0.4); background-color: #ffeaa7; }

        .quiz-panel { width: 100%; text-align: left; padding-bottom: 20px; }
        .question-row { 
            background: #fff; border: 2px solid var(--purple); margin-bottom: 12px; padding: 10px; 
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; 
            font-size: 1.5rem; font-weight: bold; color: #2d3436;
        }
        .question-content { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 10px;}
        
        /* æ•¸å­—è¼¸å…¥æ¡† */
        .question-row input { 
            font-size: 1.6rem; width: 80px; text-align: center; border: 2px solid #ccc; 
            border-radius: 8px; font-family: var(--pixel-font); padding: 5px;
        }
        
        /* æ™‚é˜ç•«å¸ƒ */
        canvas.clock-canvas {
            background: #fff;
            border-radius: 50%;
            border: 4px solid #2d3436;
            margin: 10px 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .correct-ans { color: #00b894; font-size: 1.2rem; margin-top: 5px; font-weight: bold; }

        .story-card { background: #fff; padding: 20px; border: 4px dashed var(--purple); border-radius: 15px; max-width: 90%; }
        .story-text { font-size: 1.5rem; line-height: 1.5; color: #2d3436; margin-bottom: 20px; text-align: left; font-weight: bold; }
        .item-preview { font-size: 5rem; animation: float 2s infinite ease-in-out; margin: 10px 0; }
        
        .reward-desc { background: #fff5e6; border: 2px solid #fab1a0; padding: 10px; border-radius: 10px; font-size: 1.4rem; color: #d35400; margin: 10px 0; font-weight: bold; }
        .praise-text { color: #27ae60; font-size: 1.8rem; font-weight: bold; text-shadow: 1px 1px 0 #fff; margin-top: 10px; animation: bounce 2s infinite; }

        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        @keyframes bounce { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }
        .firework { position: absolute; width: 10px; height: 10px; border-radius: 50%; animation: explode 1s ease-out forwards; pointer-events: none; }
        @keyframes explode { to { transform: scale(10); opacity: 0; } }
    </style>
</head>
<body>

<div class="game-boy">
    <div class="screen-container">
        
        <div id="screen-setup" class="screen-section active">
            <h1 style="font-size: 2.2rem;">ğŸ€ å»ºç«‹å…¬ä¸»æª”æ¡ˆ ğŸ€</h1>
            <p style="font-size: 1.4rem;">è«‹è¼¸å…¥å…¬ä¸»çš„åå­—ï¼š</p>
            <input type="text" id="player-name" class="input-box" placeholder="ä¾‹å¦‚: è‰¾è" maxlength="8">
            <p style="font-size: 1.4rem; margin-top: 15px;">é¸æ“‡ä½ çš„æ¨£å­ï¼š</p>
            <div class="avatar-select">
                <img src="1.jpg" class="avatar-opt" data-id="1.jpg" onclick="selectAvatar(this)" onerror="this.src='https://via.placeholder.com/80?text=P1'">
                <img src="2.jpg" class="avatar-opt" data-id="2.jpg" onclick="selectAvatar(this)" onerror="this.src='https://via.placeholder.com/80?text=P2'">
                <img src="3.jpg" class="avatar-opt" data-id="3.jpg" onclick="selectAvatar(this)" onerror="this.src='https://via.placeholder.com/80?text=P3'">
                <img src="4.jpg" class="avatar-opt" data-id="4.jpg" onclick="selectAvatar(this)" onerror="this.src='https://via.placeholder.com/80?text=P4'">
            </div>
            <button class="pixel-btn" style="background-color: #00b894;" onclick="startGame()">âœ¨ å»ºç«‹æª”æ¡ˆ & é–‹å§‹ âœ¨</button>
        </div>

        <div id="screen-home" class="screen-section">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <div style="font-size:1.2rem; font-weight:bold;">å…¬ä¸»: <span id="display-name" style="color:var(--deep-pink);"></span></div>
                <button style="font-size:0.9rem; background:#b2bec3; border:2px solid #000; cursor:pointer; border-radius: 5px; padding:5px 8px;" onclick="resetGame()">é‡ç½®</button>
            </div>
            <div class="princess-stage">
                <img id="l-base-img" src="" class="layer-base-img">
                <div id="l-dress" class="layer layer-dress"></div>
                <div id="l-shoes" class="layer layer-shoes"></div>
                <div id="l-hair" class="layer layer-hair"></div>
                <div id="l-wand" class="layer layer-wand"></div>
                <div id="l-pet" class="layer layer-pet"></div>
                <div id="l-crown" class="layer layer-crown"></div>
            </div>
            <div id="status-text" style="font-size: 1.2rem; color: #636e72; margin-top:10px; font-weight:bold;">æº–å‚™åƒåŠ çš‡å®¶èˆæœƒ...</div>
            <button id="next-level-btn" class="pixel-btn" onclick="enterStoryMode()">å‰å¾€ä¸‹ä¸€ç« </button>
        </div>

        <div id="screen-story" class="screen-section">
            <div class="story-card">
                <h2 id="story-title" style="font-size: 1.8rem;">ç¬¬ä¸€ç« </h2>
                <div id="story-reward-icon" class="item-preview">â“</div>
                <p id="story-content" class="story-text">æ•…äº‹å…§å®¹...</p>
                <button class="pixel-btn" onclick="startQuiz()">æ¥å—è©¦ç…‰</button>
            </div>
        </div>

        <div id="screen-quiz" class="screen-section" style="justify-content: flex-start;">
            <div style="display:flex; justify-content:space-between; width:100%; margin-bottom:10px; border-bottom:2px dashed #000; padding-bottom:5px;">
                <span style="font-size:1.4rem; font-weight:bold;">âœ¨ é­”æ³•è©¦ç…‰ä¸­ âœ¨</span>
            </div>
            <div id="quiz-list" class="quiz-panel"></div>
            <button class="pixel-btn" style="background:#00b894; width:100%;" onclick="submitQuiz()">æ–½å±•é­”æ³• (æäº¤)</button>
        </div>

        <div id="screen-success" class="screen-section">
            <h1 style="font-size:2.2rem;">âœ¨ è©¦ç…‰æˆåŠŸ âœ¨</h1>
            <div id="praise-display" class="praise-text">ä½ çœŸæ˜¯å€‹å¤©æ‰ï¼</div>
            <p style="font-size:1.4rem; margin:10px 0;">ä½ ç²å¾—äº†ç¨€æœ‰å¯¶ç‰©ï¼š</p>
            <div id="reward-display" style="font-size:5rem; animation: bounce 1s infinite;"></div>
            <p id="reward-name" style="color:var(--deep-pink); font-size:1.8rem; font-weight:bold; margin:0;"></p>
            <div id="reward-desc" class="reward-desc">é€™æ˜¯ä¸€ä»¶å‚³èªªä¸­çš„å¯¶ç‰©</div>
            <button class="pixel-btn" onclick="goHome()">æ”¾å…¥èƒŒåŒ…</button>
        </div>
        
        <div id="screen-final" class="screen-section">
            <h1 style="color:#d63031; font-size:2.2rem;">ğŸ‰ å®Œç¾å…¬ä¸»èª•ç”Ÿ ğŸ‰</h1>
            <div class="princess-stage" style="transform: scale(1.1); margin: 20px auto; background: linear-gradient(to top, #fff 0%, #fff0f5 100%); border-radius: 20px;">
                 <img id="f-base-img" src="" class="layer-base-img">
                 <div class="layer layer-dress unlocked" id="f-dress"></div>
                 <div class="layer layer-shoes unlocked" id="f-shoes"></div>
                 <div class="layer layer-hair unlocked" id="f-hair"></div>
                 <div class="layer layer-wand unlocked" id="f-wand"></div>
                 <div class="layer layer-pet unlocked" id="f-pet"></div>
                 <div class="layer layer-crown unlocked" id="f-crown"></div>
            </div>
            <p style="font-size:1.6rem; font-weight:bold;">[NAME] å…¬ä¸»å¤ªç¾äº†ï¼</p>
            <button class="pixel-btn" onclick="resetGame()">é‡æ–°é–‹å§‹å†’éšª</button>
        </div>

    </div>
</div>

<script>
    let player = { 
        name: "", 
        avatarId: "1.jpg", 
        level: 0, 
        inventory: { dress:null, shoes:null, hair:null, wand:null, pet:null, crown:null }
    };
    let selectedAvatarId = "1.jpg"; 

    // --- éš¨æ©Ÿå¯¶ç‰©åº« ---
    const lootPool = {
        dress: [{ icon: "ğŸ‘—", name: "æ˜Ÿç©ºç¦®æœ", desc: "é–ƒçˆè‘—æ˜Ÿæ˜Ÿå…‰èŠ’ï¼" }, { icon: "ğŸ‘˜", name: "æ«»èŠ±å’Œæœ", desc: "æ•£ç™¼è‘—æ·¡æ·¡èŠ±é¦™ã€‚" }, { icon: "ğŸ§œâ€â™€ï¸", name: "äººé­šç¦®æœ", desc: "åœ¨é™½å…‰ä¸‹æœƒè®Šè‰²ã€‚" }, { icon: "ğŸ’ƒ", name: "ç†±æƒ…èˆè£™", desc: "ç©¿ä¸Šå°±æƒ³è·³èˆï¼" }],
        shoes: [{ icon: "ğŸ‘ ", name: "ç»ç’ƒé‹", desc: "å°å¿ƒä¸è¦è·‘ä¸Ÿäº†ï¼" }, { icon: "ğŸ‘¡", name: "é»ƒé‡‘æ¶¼é‹", desc: "åœ‹ç‹é€çš„ç¦®ç‰©ã€‚" }, { icon: "ğŸ‘¢", name: "å†’éšªé•·é´", desc: "èµ°å†é éƒ½ä¸æœƒç´¯ã€‚" }],
        hair: [{ icon: "ğŸ€", name: "çµ²ç¶¢è´è¶çµ", desc: "ç”¨æœ€æŸ”è»Ÿçš„çµ²ç¶¢åšçš„ã€‚" }, { icon: "ğŸŒ¸", name: "èŠ±æœµé«®åœˆ", desc: "èœœèœ‚å¯èƒ½æœƒé£›éä¾†ï¼" }, { icon: "ğŸ’", name: "å¯¶çŸ³é«®å¤¾", desc: "é–ƒäº®äº®çš„éå¸¸è€€çœ¼ã€‚" }],
        wand: [{ icon: "ğŸª„", name: "æ˜Ÿå…‰é­”æ–", desc: "æ®èˆæ™‚æœƒæœ‰æµæ˜Ÿã€‚" }, { icon: "ğŸ­", name: "ç”œå¿ƒæ‰‹æ–", desc: "æ“æœ‰ç”œèœœé­”æ³•ã€‚" }, { icon: "ğŸŒ™", name: "æœˆäº®æ¬Šæ–", desc: "å¸æ”¶äº†æ»¿æœˆèƒ½é‡ã€‚" }],
        pet: [{ icon: "ğŸ¦„", name: "å½©è™¹ç¨è§’ç¸", desc: "æœ€å–œæ­¡åƒç´…è˜¿è””ï¼" }, { icon: "ğŸ‰", name: "å™´ç«å°é¾", desc: "å†¬å¤©æŠ±è‘—å¾ˆæº«æš–ã€‚" }, { icon: "ğŸˆ", name: "é­”æ³•è²“å’ª", desc: "æœƒèªªäººé¡çš„èªè¨€ã€‚" }, { icon: "ğŸ•Šï¸", name: "å’Œå¹³é´¿", desc: "å¸¶ä¾†å¥½æ¶ˆæ¯çš„é³¥å…’ã€‚" }],
        crown: [{ icon: "ğŸ‘‘", name: "å¥³ç‹çš‡å† ", desc: "çµ±æ²»ç‹åœ‹çš„è±¡å¾µã€‚" }, { icon: "ğŸ§¢", name: "æ™ºæ…§å¸½", desc: "ç®—è¡“è®Šè¶…å¿«ï¼" }, { icon: "ğŸŒ»", name: "å¤ªé™½èŠ±å† ", desc: "å……æ»¿æ´»åŠ›èˆ‡å¸Œæœ›ã€‚" }]
    };

    const praises = ["ä½ çœŸæ˜¯å€‹å¤©æ‰ï¼", "å¤ªæ£’äº†ï¼", "å®Œç¾çš„è¡¨ç¾ï¼", "é€™ç¨®é¡Œç›®é›£ä¸å€’ä½ ï¼", "å“‡ï¼ä½ é€²æ­¥å¥½å¤šå–”ï¼", "é€™æ˜¯å…¬ä¸»ç´šçš„æ™ºæ…§ï¼", "ç¹¼çºŒä¿æŒï¼"];

    const stages = [
        { title: "ç¬¬ä¸€ç« ï¼šè¡£æ«¥é­”æ³•", text: "è¡£æ«¥ç©ºç©ºçš„ï¼è«‹è§£é–‹ã€ŒåŠ æ³•ã€è¬é¡Œï¼Œè®Šå‡ºç¦®æœï¼", slot: "dress", quizType: ["add", "missing"], diff: {min:10, max:50} },
        { title: "ç¬¬äºŒç« ï¼šå°‹æ‰¾é‹å­", text: "å…‰è‘—è…³ä¸«æ€éº¼è·³èˆï¼Ÿç”¨ã€Œæ¸›æ³•ã€æˆ–ã€Œå¡«ç©ºã€æ‰¾å›é‹å­ï¼", slot: "shoes", quizType: ["sub", "missing"], diff: {min:20, max:60} },
        { title: "ç¬¬ä¸‰ç« ï¼šæ•´ç†é ­é«®", text: "é ­é«®äº‚ç³Ÿç³Ÿï¼Œè§€å¯Ÿã€Œæ•¸å­—è¦å¾‹ã€è®Šå‡ºæ¼‚äº®çš„é«®é£¾ï¼", slot: "hair", quizType: ["mul", "sequence"], diff: {min:2, max:9} },
        { title: "ç¬¬å››ç« ï¼šæ™‚é–“ç®¡ç†", text: "èˆæœƒå¹¾é»é–‹å§‹ï¼Ÿçœ‹è‘—ã€Œæ™‚é˜ã€å›ç­”æ­£ç¢ºæ™‚é–“ï¼", slot: "wand", quizType: ["visual_clock"], diff: {} },
        { title: "ç¬¬äº”ç« ï¼šç¥ç¸å¤¥ä¼´", text: "è·¯é€”å¤ªé äº†ï¼Œç”¨ã€Œæ‡‰ç”¨é¡Œã€å¬å–šå°å¤¥ä¼´è¼‰æˆ‘å€‘ï¼", slot: "pet", quizType: ["word"], diff: {min:20, max:80} },
        { title: "æœ€çµ‚ç« ï¼šå¥³ç‹åŠ å†•", text: "è­‰æ˜ä½ çš„æ™ºæ…§ï¼Œé€šéç¶œåˆè€ƒé©—è´å¾—çš‡å† ï¼", slot: "crown", quizType: ["add", "sub", "mul", "visual_clock"], diff: {min:10, max:99} }
    ];

    // æ‡‰ç”¨é¡Œåº«
    const wordProblems = [
        { text: "å…¬ä¸»æœ‰ {n1} é¡†å¯¶çŸ³ï¼Œåœ‹ç‹åˆçµ¦äº†å¥¹ {n2} é¡†ï¼Œç¾åœ¨æœ‰å¹¾é¡†ï¼Ÿ", op: "+" },
        { text: "èŠ±åœ’è£¡æœ‰ {n1} æœµç«ç‘°ï¼Œæ¡èµ°äº† {n2} æœµï¼Œé‚„å‰©å¹¾æœµï¼Ÿ", op: "-" },
        { text: "æ¯éš»é’è›™æœ‰ 4 æ¢è…¿ï¼Œ{n1} éš»é’è›™å…±æœ‰å¹¾æ¢è…¿ï¼Ÿ", op: "mul_fix_4" }, 
        { text: "ä¸€ç›’é¦¬å¡é¾æœ‰ {n1} å€‹ï¼Œè²·äº† {n2} ç›’ï¼Œç¸½å…±æœ‰å¹¾å€‹ï¼Ÿ", op: "*" },
        { text: "æ’éšŠé€²åŸå ¡ï¼Œå°å…¬ä¸»å‰é¢æœ‰ {n1} äººï¼Œå¾Œé¢æœ‰ {n2} äººï¼Œé€™ä¸€æ’å…±æœ‰å¹¾äººï¼Ÿ(åŠ è‡ªå·±)", op: "queue" },
        { text: "ä¸€æé­”æ³•ç­†è³£ {n2} å…ƒï¼Œå…¬ä¸»è²·äº† 1 æï¼Œä»˜äº† {n1} å…ƒï¼Œè¦æ‰¾å›å¹¾å…ƒï¼Ÿ", op: "-" },
        { text: "æ›¸æ¶ä¸Šç¬¬ä¸€å±¤æœ‰ {n1} æœ¬æ›¸ï¼Œç¬¬äºŒå±¤æ¯”ç¬¬ä¸€å±¤å¤š {n2} æœ¬ï¼Œç¬¬äºŒå±¤æœ‰å¹¾æœ¬ï¼Ÿ", op: "+" },
        { text: "å…¬è»Šä¸ŠåŸæœ¬æœ‰ {n1} äººï¼Œåˆ°ç«™ä¸‹å» {n2} äººï¼Œè»Šä¸Šå‰©ä¸‹å¹¾äººï¼Ÿ", op: "-" }
    ];

    let currentQuestions = [];

    window.onload = function() {
        const firstOpt = document.querySelector('.avatar-opt[data-id="1.jpg"]');
        if(firstOpt) selectAvatar(firstOpt);
        try {
            if(localStorage.getItem('princessStorySave')) {
                const saved = JSON.parse(localStorage.getItem('princessStorySave'));
                if(saved && saved.name && saved.inventory) {
                    player = saved;
                    showScreen('screen-home');
                    updateHomeVisuals();
                }
            }
        } catch(e) {}
    };

    function saveGame() { try { localStorage.setItem('princessStorySave', JSON.stringify(player)); } catch (e) {} }
    function resetGame() { if(confirm("ç¢ºå®šè¦é‡ç½®é€²åº¦å—ï¼Ÿæ‰€æœ‰è£å‚™éƒ½æœƒæ¶ˆå¤±å–”ï¼")) { try { localStorage.removeItem('princessStorySave'); } catch(e){} location.reload(); } }

    function selectAvatar(element) {
        selectedAvatarId = element.dataset.id;
        document.querySelectorAll('.avatar-opt').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }

    function startGame() {
        const nameInput = document.getElementById('player-name').value.trim();
        if(!nameInput) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        player.name = nameInput;
        player.avatarId = selectedAvatarId; 
        saveGame();
        showScreen('screen-home');
        updateHomeVisuals();
    }

    function showScreen(id) {
        document.querySelectorAll('.screen-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateHomeVisuals() {
        document.getElementById('display-name').innerText = player.name;
        document.getElementById('l-base-img').src = player.avatarId;
        const fBaseImg = document.getElementById('f-base-img');
        if(fBaseImg) fBaseImg.src = player.avatarId;

        updateLayer('l-dress', 'dress');
        updateLayer('l-shoes', 'shoes');
        updateLayer('l-hair', 'hair');
        updateLayer('l-wand', 'wand');
        updateLayer('l-pet', 'pet');
        updateLayer('l-crown', 'crown');
        
        updateLayer('f-dress', 'dress');
        updateLayer('f-shoes', 'shoes');
        updateLayer('f-hair', 'hair');
        updateLayer('f-wand', 'wand');
        updateLayer('f-pet', 'pet');
        updateLayer('f-crown', 'crown');

        if(player.level >= 6) {
            document.getElementById('status-text').innerText = "æ”¶é›†å®Œæˆï¼";
            const btn = document.getElementById('next-level-btn');
            btn.innerText = "åƒåŠ åŠ å†•å…¸ç¦®";
            btn.onclick = () => showFinal();
        } else {
            document.getElementById('status-text').innerText = `ç¬¬ ${player.level + 1} ç« ï¼š${stages[player.level].title}`;
            const btn = document.getElementById('next-level-btn');
            btn.innerText = "é€²å…¥æ•…äº‹";
            btn.onclick = () => enterStoryMode();
        }
    }

    function updateLayer(elementId, slot) {
        const el = document.getElementById(elementId);
        if(!el) return;
        const item = player.inventory[slot];
        if(item) {
            el.innerText = item.icon;
            el.classList.add('unlocked');
        } else {
            el.innerText = "";
            el.classList.remove('unlocked');
        }
    }

    function enterStoryMode() {
        if(player.level >= 6) return;
        const stage = stages[player.level];
        document.getElementById('story-title').innerText = stage.title;
        document.getElementById('story-content').innerText = stage.text;
        document.getElementById('story-reward-icon').innerText = "â“"; 
        showScreen('screen-story');
    }

    function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function startQuiz() {
        showScreen('screen-quiz');
        const container = document.getElementById('quiz-list');
        container.innerHTML = ''; 
        currentQuestions = [];
        const stage = stages[player.level];
        // é™åˆ¶æœ€å¤š 5 é¡Œ
        for(let i=0; i<5; i++) {
            const type = stage.quizType[Math.floor(Math.random() * stage.quizType.length)];
            createQuestion(i, type, stage.diff);
        }
        
        // å»¶é²ç¹ªè£½æ™‚é˜ï¼Œç¢ºä¿ DOM å·²ç¶“å­˜åœ¨
        setTimeout(() => {
            currentQuestions.forEach((q, index) => {
                if(q.type === 'visual_clock') {
                    drawClock(`q-clock-${index}`, q.h, q.m);
                }
            });
        }, 100);
    }

    // --- ç¹ªè£½æ™‚é˜çš„å‡½å¼ ---
    function drawClock(canvasId, hour, minute) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext("2d");
        const radius = canvas.height / 2;
        ctx.translate(radius, radius);
        const r = radius * 0.90;

        // ç•«åœ“ç›¤
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, 2 * Math.PI);
        ctx.fillStyle = 'white'; ctx.fill();
        ctx.lineWidth = 3; ctx.strokeStyle = '#2d3436'; ctx.stroke();

        // ç•«åˆ»åº¦
        for(let num = 1; num <= 12; num++){
            let ang = num * Math.PI / 6;
            ctx.rotate(ang); ctx.translate(0, -r * 0.85); ctx.rotate(-ang);
            ctx.font = "bold 12px Arial"; ctx.fillStyle = "#2d3436"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(num.toString(), 0, 0);
            ctx.rotate(ang); ctx.translate(0, r * 0.85); ctx.rotate(-ang);
        }

        // ç•«æ™‚é‡
        let hPos = (hour % 12) * Math.PI / 6 + (minute * Math.PI / (6 * 60));
        drawHand(ctx, hPos, r * 0.5, 4, "#2d3436");
        // ç•«åˆ†é‡
        let mPos = (minute * Math.PI / 30);
        drawHand(ctx, mPos, r * 0.75, 2, "#e84393"); // åˆ†é‡æ˜¯ç²‰ç´…è‰²çš„
        
        ctx.translate(-radius, -radius); // é‡ç½®
    }

    function drawHand(ctx, pos, length, width, color) {
        ctx.beginPath(); ctx.lineWidth = width; ctx.lineCap = "round"; ctx.strokeStyle = color;
        ctx.moveTo(0,0); ctx.rotate(pos); ctx.lineTo(0, -length); ctx.stroke(); ctx.rotate(-pos);
    }

    function createQuestion(index, type, diff) {
        let q = { type: type, ans: null, h:0, m:0 };
        let html = '';
        const min = diff.min || 10;
        const max = diff.max || 50;
        let n1, n2;

        if(type === 'visual_clock') {
            // ç”¢ç”Ÿæ™‚é˜é¡Œï¼šåªæœ‰æ•´é»æˆ–åŠé»ï¼Œé©åˆäºŒå¹´ç´š
            let h = getRandomInt(1, 12);
            let m = getRandomInt(0, 1) * 30; // 0 æˆ– 30
            q.h = h; q.m = m;
            q.type = 'visual_clock';
            // åˆ¤æ–·é¡Œå‹ï¼šçœ‹æ™‚é˜å¯«æ™‚é–“ï¼Œæˆ–çœ‹æ™‚é˜+1å°æ™‚
            let mode = getRandomInt(0, 1);
            if(mode === 0) {
                // åŸºæœ¬é¡Œï¼šç¾åœ¨å¹¾é»ï¼Ÿ
                // ç­”æ¡ˆæ ¼å¼ç‚º h:mm (ä¾‹å¦‚ 3:30)
                q.ans = `${h}:${m === 0 ? "00" : "30"}`;
                html = `<div style="text-align:center; width:100%;">
                        <span>ç¾åœ¨æ˜¯å¹¾é»å¹¾åˆ†ï¼Ÿ</span><br>
                        <canvas id="q-clock-${index}" width="100" height="100" class="clock-canvas"></canvas>
                        <br><span style="font-size:1rem; color:#666;">(æ ¼å¼: 3:00 æˆ– 3:30)</span>
                        </div>`;
            } else {
                // é€²éšé¡Œï¼šéä¸€å°æ™‚æ˜¯å¹¾é»ï¼Ÿ
                let nextH = h + 1;
                if(nextH > 12) nextH = 1;
                q.ans = `${nextH}:${m === 0 ? "00" : "30"}`;
                 html = `<div style="text-align:center; width:100%;">
                        <span>é 1 å°æ™‚å¾Œæ˜¯å¹¾é»ï¼Ÿ</span><br>
                        <canvas id="q-clock-${index}" width="100" height="100" class="clock-canvas"></canvas>
                        </div>`;
            }

        } else if(type === 'add') {
            n1 = getRandomInt(min, max); n2 = getRandomInt(min, max);
            q.ans = n1 + n2; html = `${n1} + ${n2} = ?`;
        } else if(type === 'sub') {
            n1 = getRandomInt(min, max); n2 = getRandomInt(min, max);
            if(n1 < n2) [n1, n2] = [n2, n1];
            q.ans = n1 - n2; html = `${n1} - ${n2} = ?`;
        } else if(type === 'mul') {
            n1 = getRandomInt(2, 9); n2 = getRandomInt(2, 9);
            q.ans = n1 * n2; html = `${n1} Ã— ${n2} = ?`;
        } else if(type === 'missing') {
            n1 = getRandomInt(min, max); let result = getRandomInt(n1 + 5, n1 + 20);
            q.ans = result - n1; html = `${n1} + ( ? ) = ${result}`;
        } else if(type === 'sequence') {
            let start = getRandomInt(1, 10); let step = getRandomInt(2, 5);
            let s1 = start, s2 = start+step, s3 = start+step*2;
            q.ans = start + step*3; html = `${s1}, ${s2}, ${s3}, ( ? )`;
        } else if(type === 'word') {
             let p = wordProblems[getRandomInt(0, wordProblems.length - 1)];
             if(p.op === 'mul_fix_4') { n1 = getRandomInt(2, 9); n2=0; q.ans = n1 * 4; }
             else if(p.op === 'queue') { n1 = getRandomInt(3, 10); n2 = getRandomInt(3, 10); q.ans = n1 + n2 + 1; }
             else {
                 n1 = getRandomInt(min, max); n2 = getRandomInt(5, 15);
                 if(p.op === '-') { if(n1 < n2) [n1, n2] = [n2, n1]; q.ans = n1 - n2; }
                 else if(p.op === '+') q.ans = n1 + n2;
                 else if(p.op === '*') { n1 = getRandomInt(2, 6); n2 = getRandomInt(2, 5); q.ans = n1 * n2; }
             }
             html = p.text.replace('{n1}', n1).replace('{n2}', n2);
        }

        const div = document.createElement('div');
        div.className = 'question-row';
        
        let inputField = '';
        if(type === 'visual_clock') {
             inputField = `<input type="text" id="ans-${index}" placeholder="æ™‚:åˆ†">`;
        } else {
             inputField = `<input type="number" id="ans-${index}" inputmode="numeric">`;
        }

        div.innerHTML = `<div class="question-content"><span style="flex:1;">${index+1}. ${html}</span></div> ${inputField}`; 
        document.getElementById('quiz-list').appendChild(div); 
        currentQuestions.push(q);
    }

    function submitQuiz() {
        let correctCount = 0;
        currentQuestions.forEach((q, idx) => {
            const input = document.getElementById(`ans-${idx}`);
            let val = input.value.trim();
            
            // è™•ç†æ™‚é˜é¡Œçš„å†’è™Ÿæ ¼å¼ (3:00, 03:00, 3:0)
            if(q.type === 'visual_clock') {
                // çµ±ä¸€æ ¼å¼åŒ–ï¼šè£œ0
                let parts = val.split(/[:ï¼š]/);
                if(parts.length === 2) {
                    let h = parseInt(parts[0]);
                    let m = parseInt(parts[1]);
                    // ç°¡å–®æ¯”è¼ƒå­—ä¸²
                    let standardUser = `${h}:${m === 0 ? "00" : "30"}`;
                    // å®¹éŒ¯: å¦‚æœé¡Œç›®æ˜¯ 3:00ï¼Œuser è¼¸å…¥ 3 ä¹Ÿç®—å°
                    if(standardUser === q.ans) {
                         input.style.borderColor = "#00b894"; input.style.backgroundColor = "#d4edda";
                         correctCount++;
                         return;
                    }
                }
                // éŒ¯èª¤è™•ç†
                input.style.borderColor = "#d63031"; input.style.backgroundColor = "#fab1a0";
            } else {
                if(parseInt(val) === q.ans) {
                    input.style.borderColor = "#00b894"; input.style.backgroundColor = "#d4edda";
                    correctCount++;
                } else {
                    input.style.borderColor = "#d63031"; input.style.backgroundColor = "#fab1a0";
                }
            }
        });

        if(correctCount === 5) {
            setTimeout(() => { levelClear(); }, 500);
        } else {
            alert(`ç­”å° ${correctCount}/5 é¡Œã€‚è«‹è¨‚æ­£ç´…è‰²çš„é¡Œç›®ï¼`);
        }
    }

    function levelClear() {
        const stage = stages[player.level];
        const slot = stage.slot;
        const possibleItems = lootPool[slot];
        const newItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
        const randomPraise = praises[Math.floor(Math.random() * praises.length)];

        player.inventory[slot] = newItem;
        player.level++;
        saveGame();

        document.getElementById('praise-display').innerText = randomPraise;
        document.getElementById('reward-display').innerText = newItem.icon;
        document.getElementById('reward-name').innerText = newItem.name;
        document.getElementById('reward-desc').innerText = newItem.desc;

        showScreen('screen-success');
        for(let i=0; i<15; i++) createFirework();
    }

    function goHome() {
        showScreen('screen-home');
        updateHomeVisuals();
    }

    function showFinal() {
        showScreen('screen-final');
        document.body.innerHTML = document.body.innerHTML.replace("[NAME]", player.name);
        setInterval(createFirework, 800);
    }

    function createFirework() {
        const fw = document.createElement('div');
        fw.className = 'firework';
        fw.style.left = Math.random() * 90 + 5 + '%';
        fw.style.top = Math.random() * 80 + 10 + '%';
        fw.style.backgroundColor = ['#fab1a0', '#e84393', '#6c5ce7', '#ffeaa7'][Math.floor(Math.random()*4)];
        document.body.appendChild(fw);
        setTimeout(() => fw.remove(), 1000);
    }
</script>
</body>
</html>
